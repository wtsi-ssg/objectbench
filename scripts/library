# Ensure we are using rvm

function two_phase_test {
cd $OBJECT_BENCH_HOME
echo "Persting errors to database"
bundle exec rake object_bench:persist_resque_errors
echo "clearing errors"
bundle exec rake object_bench:delete_resque_errors
export OBJECTBENCH_TAG="Test_run_${OBJECTBENCH_SYSTEM_UNDER_TEST}_bulk_write_$$"
echo "Tagging tests as ${OBJECTBENCH_TAG}"
echo closing floodgates
rake object_bench:close_floodgate
bundle exec rake object_bench:add_initial_writes
echo opening floodgates
rake object_bench:open_floodgate
bundle exec rake object_bench:wait_for_stable
echo "Loading tests"
echo closing floodgates
rake object_bench:close_floodgate
# Reads should come from the run we have just completed.
export OBJECTBENCH_TAG_READ=${OBJECTBENCH_TAG}
export OBJECTBENCH_TAG="Test_run_${OBJECTBENCH_SYSTEM_UNDER_TEST}_phase_two_$$"
bundle exec rake object_bench:load_tests
echo opening floodgates
rake object_bench:open_floodgate
echo "Test Tagged as ${OBJECTBENCH_TAG}"
bundle exec rake object_bench:wait_for_stable
echo "Persting errors to database"
bundle exec rake object_bench:persist_resque_errors
echo "Test Tagged as ${OBJECTBENCH_TAG}"
}

function setup_two_read_write_test {
# A vaiable used to make listing the files in this function simpler.
export OB_D_BASE="/warehouse/isg_wh_scratch01/users/jb23/object_test"
# OBJECTBENCH_INITAL_FILES is the list of files used for writes to the object
# store in the first first phase of the tests. These files are read as part
# of the second phase. Alternatively this phase can be used to fill the 
# object store up to a specific amount before  running any tests.
#
# OBJECTBENCH_INITAL_DISTRIBUTION this is used to specify how many of each of
# the files in OBJECTBENCH_INITAL_FILES is placed in to the object store for
# example "1,2,3,4,5,6,7" would store one of the first file, two of the 
# second etc.
export OBJECTBENCH_INITAL_DISTRIBUTION="86, 103, 68, 113, 588, 405, 140, 29, 137, 117, 3"
export OBJECTBENCH_INITAL_FILES="${OB_D_BASE}/zero_length \
                                 ${OB_D_BASE}/11166_2#168.bai \
                                 ${OB_D_BASE}/11128_8#0_phix.flagstat \
                                 ${OB_D_BASE}/11330_1#19.bamcheck  \
                                 ${OB_D_BASE}/11304_1#86_phix_quality_error.txt \
                                 ${OB_D_BASE}/11310_2#56_phix_quality_cycle_surv.txt 
                                 ${OB_D_BASE}/6320_5.bai \
                                 ${OB_D_BASE}/6244_1#9.bam \
                                 ${OB_D_BASE}/6350_4#1.bam \
                                 ${OB_D_BASE}/11149_5#12.cram \
                                 ${OB_D_BASE}/7231_1#146.bam"
# This is the approximate distribution of file sizes in the main test
export OBJECTBENCH_TEST_WRITE_DISTRIBUTION="$OBJECTBENCH_INITAL_DISTRIBUTION"
# This is the distribution of Write,reads and partial reads
export OBJECTBENCH_TEST_WORKLOAD_DISTRIBUTION="600,300,100"
# This is the default tag of the run hopefully with the name of the subject 
# included.
export OBJECTBENCH_TAG="Test_run_${OBJECTBENCH_SYSTEM_UNDER_TEST}_$$"
 }
